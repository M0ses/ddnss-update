#!/bin/bash


WORKING_DIR="/var/lib/ddnss/"
LOG_FILE=/var/log/ddnss/ddnss-update.log

# set default loglevel
LOGLEVEL=3

. /etc/ddnss/ddnss-update.rc

if [ -z "$FORCE_UPDATE" ];then
  FORCE_UPDATE=86400
fi

function logmsg {
  LL=$1
  shift
  [ "$LL" -le "$LOGLEVEL" ] && echo "$CURRENT_DATE - $@" >> $LOG_FILE
}

CURRENT_DATE=`date +%Y-%m-%d\ %H:%M:%S`

IP6=`curl https://ip6.ddnss.de/meineip.php 2>/dev/null| grep -o '[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}\:[0-9a-z]\{1,4\}'`
IP=`curl https://ip4.ddnss.de/meineip.php 2>/dev/null| grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}'`

UPDIP=`cat $WORKING_DIR/last.ip 2>/dev/null||echo -en ''`
UPDIP6=`cat $WORKING_DIR/last.ip6 2>/dev/null||echo -en ''`

logmsg 5 "Current IP=$UPDIP"
logmsg 5 "Current IP=$UPDIP6"

NOW=`date +%s`
LAST_UPDATE=`stat -c %Y $WORKING_DIR/last.ip`
NEXT_UPDATE=$(( $LAST_UPDATE + $FORCE_UPDATE ))

[ $NOW -lt $NEXT_UPDATE ]
UPDATE_NOW=$?

[ "$IP" == "$UPDIP" -a "$IP6" == "$UPDIP6" ]
IP_SAME=$?


if [ $IP_SAME == 0 -a $UPDATE_NOW == 0 ]; then

   logmsg 4 "IP is the same - NO UPDATE"

else
   logmsg 5 "New IP: $IP / Old IP: $UPDIP - UPDATE!"
   logmsg 5 "New IP6: $IP6 / Old IP6: $UPDIP6 - UPDATE!"

   echo $IP > $WORKING_DIR/last.ip
   echo $IP6 > $WORKING_DIR/last.ip6
   CMD="curl -v https://ddnss.de/upd.php?key=$KEYAUTH&host=$HOSTNAME&ip=$IP&ip6=$IP6"
   logmsg 5 "COMMAND: $CMD"
   HTTP=`$CMD 2>&1`
   FOUND=`echo "$HTTP"|grep "DDNSS-Response: good"`
   if [ -n "$FOUND" ];then
     logmsg 4 "Update ... (IPv4=$IP/IPv6=$IP6)"
   else
     logmsg 1 "Something went wrong: $HTTP"
   fi
fi
